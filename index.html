<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ระบบจองล็อคตลาดสตาร์ สาขามาบตาพุด</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Sarabun', sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f5f5f5;
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin: 15px 0 20px;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .search-container {
            margin: 0 auto 20px;
            width: 100%;
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Sarabun', sans-serif;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            min-height: 50px;
            background-color: white;
        }
        
        .search-btn {
            background-color: #9b59b6;
            min-width: 90px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
        }
        
        .controls {
            text-align: center;
            margin: 0 auto 25px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 800px;
        }
        
        button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 14px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            min-height: 50px;
            -webkit-appearance: none;
            appearance: none;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        button:active {
            opacity: 0.8;
        }
        
        .view-btn {
            background-color: #3498db;
        }
        
        .report-btn {
            background-color: #27ae60;
        }
        
        .export-btn {
            background-color: #9b59b6;
        }
        
        .price-btn {
            background-color: #f39c12;
        }
        
        .reset-btn {
            background-color: #e74c3c;
            grid-column: span 2;
        }
        
        .print-btn {
            background-color: #1abc9c;
            grid-column: span 2;
        }
        
        .zone-container {
            margin-bottom: 25px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .zone-container::-webkit-scrollbar {
            display: none;
        }
        
        .zone-title {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
            position: sticky;
            left: 0;
            font-weight: 500;
        }
        
        .locks-grid {
            display: grid;
            gap: 6px;
            justify-content: center;
            align-items: start;
            width: max-content;
            min-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        .lock {
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
            font-size: 0.9rem;
            min-width: 55px;
            min-height: 55px;
            padding: 5px;
            text-align: center;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .walkway {
            background-color: #f8f9fa;
            border: 1px dashed #ccc;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 100%;
            font-size: 0.7rem;
        }
        
        .lock-id {
            font-size: 0.8rem;
            margin-bottom: 3px;
            font-weight: 600;
        }
        
        .lock-name {
            font-size: 0.7rem;
            word-break: break-word;
            max-width: 100%;
            line-height: 1.2;
        }
        
        .lock-price {
            font-size: 0.7rem;
            color: #666;
            margin-top: 3px;
        }
        
        .booked .lock-price {
            color: #eee;
        }
        
        /* สีล็อคว่างตามโซน */
        .lock.available[data-zone="a"] {
            background-color: #fffacd;
            border-color: #ffeb3b;
        }
        
        .lock.available[data-zone="a2"] {
            background-color: #bbdefb;
            border-color: #2196f3;
        }
        
        .lock.available[data-zone="b"],
        .lock.available[data-zone="b2"] {
            background-color: #a8e6cf;
            border-color: #4caf50;
        }
        
        .lock.available[data-zone="c"] {
            background-color: #fffacd;
            border-color: #ffeb3b;
        }
        
        /* ล็อคที่จองแล้วเป็นสีแดง */
        .lock.booked {
            background-color: #ff6b6b;
            border-color: #ff5252;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            margin: 20px 0;
            touch-action: pan-y;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .modal-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: 600;
            text-align: center;
        }
        
        .modal-input {
            width: 100%;
            padding: 14px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Sarabun', sans-serif;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            min-height: 50px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .modal-actions button {
            min-height: 50px;
            padding: 14px 20px;
            font-size: 16px;
        }
        
        .report-container {
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .report-zone {
            margin-bottom: 20px;
        }
        
        .report-zone-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1rem;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .report-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .report-summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #eee;
        }
        
        .report-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .report-summary-total {
            font-weight: 600;
            border-top: 1px solid #ddd;
            padding-top: 8px;
            margin-top: 8px;
            font-size: 1rem;
        }
        
        .map-container {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .map-zone {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .map-zone-title {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 1rem;
            text-align: center;
            font-weight: 500;
        }
        
        .map-locks-grid {
            display: grid;
            gap: 4px;
            justify-content: center;
            align-items: start;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .map-lock {
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 4px;
            font-size: 0.7rem;
            min-width: 40px;
            min-height: 40px;
            padding: 3px;
            text-align: center;
        }
        
        .map-lock-id {
            font-size: 0.6rem;
            margin-bottom: 2px;
            font-weight: 600;
        }
        
        .map-lock-name {
            font-size: 0.6rem;
            word-break: break-word;
            max-width: 100%;
            line-height: 1.1;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #map-modal, #map-modal * {
                visibility: visible;
            }
            #map-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: white;
                padding: 0;
                margin: 0;
            }
            .modal-actions {
                display: none !important;
            }
            .map-lock {
                min-width: 35px;
                min-height: 35px;
            }
        }
        
        @media (min-width: 768px) {
            body {
                padding: 25px;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .controls {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .reset-btn, .print-btn {
                grid-column: span 1;
            }
            
            .lock {
                min-width: 65px;
                min-height: 65px;
                font-size: 1rem;
            }
            
            .lock-id {
                font-size: 0.9rem;
            }
            
            .lock-name {
                font-size: 0.8rem;
            }
            
            .map-lock {
                min-width: 45px;
                min-height: 45px;
                font-size: 0.8rem;
            }
            
            .map-lock-id {
                font-size: 0.7rem;
            }
            
            .map-lock-name {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <h1>ระบบจองล็อคตลาดสตาร์ สาขามาบตาพุด</h1>
    
    <div class="search-container">
        <input type="text" class="search-input" id="search-input" placeholder="ค้นหาชื่อผู้จอง...">
        <button class="search-btn" id="search-btn">ค้นหา</button>
    </div>
    
    <div class="controls">
        <button class="view-btn" id="view-all">แสดงทั้งหมด</button>
        <button class="view-btn" id="view-available">แสดงล็อคว่าง</button>
        <button class="report-btn" id="show-report">รายงาน</button>
        <button class="export-btn" id="export-csv">ส่งออก CSV</button>
        <button class="price-btn" id="manage-prices">จัดการราคา</button>
        <button class="print-btn" id="print-map">พิมพ์ผังรวม</button>
        <button class="reset-btn" id="reset-btn">รีเซ็ตทั้งหมด</button>
    </div>
    
    <!-- Zone A (5x9) -->
    <div class="zone-container">
        <div class="zone-title">โซน A (45 ล็อก)</div>
        <div class="locks-grid" id="zone-a"></div>
    </div>
    
    <!-- Zone A2 (5x9) -->
    <div class="zone-container">
        <div class="zone-title">โซน A2 (45 ล็อก)</div>
        <div class="locks-grid" id="zone-a2"></div>
    </div>
    
    <!-- Zone B (7x8) -->
    <div class="zone-container">
        <div class="zone-title">โซน B (54 ล็อก)</div>
        <div class="locks-grid" id="zone-b"></div>
    </div>
    
    <!-- Zone B2 (8x8) -->
    <div class="zone-container">
        <div class="zone-title">โซน B2 (48 ล็อก)</div>
        <div class="locks-grid" id="zone-b2"></div>
    </div>
    
    <!-- Zone C (11x12) -->
    <div class="zone-container">
        <div class="zone-title">โซน C (115 ล็อก)</div>
        <div class="locks-grid" id="zone-c"></div>
    </div>

    <!-- Modal สำหรับกรอกชื่อ -->
    <div class="modal" id="booking-modal">
        <div class="modal-content">
            <div class="modal-title">กรอกชื่อผู้จอง</div>
            <input type="text" class="modal-input" id="booker-name" placeholder="ชื่อร้านหรือประเภทสินค้า">
            <div class="modal-actions">
                <button id="cancel-booking">ยกเลิก</button>
                <button id="confirm-booking">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับรายงาน -->
    <div class="modal" id="report-modal">
        <div class="modal-content">
            <div class="modal-title">รายงานสรุปการจอง</div>
            <div class="report-container" id="report-content"></div>
            <div class="modal-actions">
                <button id="close-report">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับผังรวม -->
    <div class="modal" id="map-modal">
        <div class="modal-content" style="max-width: 90%;">
            <div class="modal-title">ผังรวมการจองล็อคตลาด</div>
            <div class="map-container" id="map-content"></div>
            <div class="modal-actions">
                <button id="print-map-btn">พิมพ์ผัง</button>
                <button id="close-map">ปิด</button>
            </div>
        </div>
    </div>

    <script>
        // โครงสร้างข้อมูลล็อค
        const zones = {
            'zone-a': { 
                rows: 9, 
                cols: 5, 
                prefix: 'A', 
                name: 'โซน A', 
                walkwayAfterCols: [2, 4],
                format: 'vertical',
                basePrice: 300,
                priceMap: {
                    'A1A': 400, 'A1B': 400, 'A1C': 350,
                    'A2A': 400, 'A2B': 400, 'A2C': 350,
                    'A9D': 350, 'A9E': 350
                }
            },
            'zone-a2': { 
                rows: 9, 
                cols: 5, 
                prefix: 'A2', 
                name: 'โซน A2', 
                walkwayAfterCols: [2, 4],
                format: 'vertical',
                basePrice: 250
            },
            'zone-b': { 
                rows: 7, 
                cols: 8, 
                prefix: 'B', 
                name: 'โซน B', 
                walkwayAfterPairs: [1, 2, 3],
                format: 'horizontal',
                pairsPerRow: 4,
                basePrice: 200,
                excludeLocks: ['B7A','B7B'],
                priceMap: {
                    'B1A': 250, 'B1B': 250,
                    'B2A': 250, 'B2B': 250,
                    'B3A': 250, 'B3B': 250
                }
            },
            'zone-b2': { 
                rows: 8, 
                cols: 8, 
                prefix: 'B2', 
                name: 'โซน B2', 
                walkwayAfterPairs: [1, 2, 3],
                format: 'horizontal',
                pairsPerRow: 4,
                basePrice: 180,
                excludeLocks: [
                    'B21A','B21B','B22A','B22B','B23A','B23B',
                    'B24A','B24B','B25A','B25B','B26A','B26B',
                    'B27A','B27B','B28A','B28B'
                ]
            },
            'zone-c': { 
                rows: 11, 
                cols: 12, 
                prefix: 'C', 
                name: 'โซน C', 
                walkwayAfterPairs: [1, 2, 3, 4, 5],
                format: 'horizontal',
                pairsPerRow: 6,
                letters: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'],
                basePrice: 150,
                excludeLocks: [
                    'C6A','C7A','C8A','C9A','C10A','C11A',
                    'C6B','C7B','C8B','C9B','C10B','C11B',
                    'C1L','C2L','C3L','C4L','C5L'
                ],
                priceMap: {
                    'C1A': 200, 'C1B': 200, 'C1C': 200,
                    'C2A': 200, 'C2B': 200, 'C2C': 200,
                    'C3A': 180, 'C3B': 180
                }
            }
        };

        // ตัวแปรเก็บข้อมูลล็อคที่กำลังจอง
        let currentBookingLock = null;
        let isScrolling = false;

        // โหลดข้อมูลจาก LocalStorage
        function loadData() {
            const savedData = localStorage.getItem('marketLocks');
            return savedData ? JSON.parse(savedData) : {};
        }

        // บันทึกข้อมูลลง LocalStorage
        function saveData(data) {
            localStorage.setItem('marketLocks', JSON.stringify(data));
        }

        // ดึงราคาล็อค
        function getLockPrice(lockId) {
            const savedPrices = localStorage.getItem('marketPrices');
            if (savedPrices) {
                const priceData = JSON.parse(savedPrices);
                
                const zonePrefix = lockId.substring(0, lockId.indexOf('-') > -1 ? lockId.indexOf('-') : 1);
                for (const zone in priceData) {
                    if ((zone === 'a' && zonePrefix === 'A') || 
                        (zone === 'a2' && zonePrefix === 'A2') ||
                        (zone === 'b' && zonePrefix === 'B' && !lockId.startsWith('B2')) ||
                        (zone === 'b2' && zonePrefix === 'B2') ||
                        (zone === 'c' && zonePrefix === 'C')) {
                        
                        if (priceData[zone].priceMap && priceData[zone].priceMap[lockId]) {
                            return priceData[zone].priceMap[lockId];
                        }
                        return priceData[zone].basePrice || 0;
                    }
                }
            }
            
            const zonePrefix = lockId.substring(0, lockId.indexOf('-') > -1 ? lockId.indexOf('-') : 1);
            const zoneId = Object.keys(zones).find(z => zones[z].prefix === zonePrefix || 
                                  (zonePrefix === 'B2' && zones[z].prefix === 'B'));
            
            if (zoneId && zones[zoneId]) {
                const zone = zones[zoneId];
                if (zone.priceMap && zone.priceMap[lockId]) {
                    return zone.priceMap[lockId];
                }
                return zone.basePrice || 0;
            }
            return 0;
        }

        // สร้างล็อคสำหรับโซนแบบแนวตั้ง (A, A2)
        function createVerticalZone(zoneId, zoneInfo) {
            const container = document.getElementById(zoneId);
            container.innerHTML = '';
            const lockData = loadData();
            
            const totalCols = zoneInfo.cols + zoneInfo.walkwayAfterCols.length;
            container.style.gridTemplateColumns = `repeat(${totalCols}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${zoneInfo.rows}, 1fr)`;
            
            for (let row = 1; row <= zoneInfo.rows; row++) {
                let gridCol = 1;
                
                for (let col = 1; col <= zoneInfo.cols; col++) {
                    if (zoneInfo.walkwayAfterCols.includes(col)) {
                        if (row === 1) {
                            const walkway = document.createElement('div');
                            walkway.className = 'walkway';
                            walkway.style.gridColumn = gridCol;
                            walkway.style.gridRow = `1 / span ${zoneInfo.rows}`;
                            walkway.textContent = 'ทางเดิน';
                            container.appendChild(walkway);
                        }
                        gridCol++;
                    }
                    
                    const lockId = `${zoneInfo.prefix}${row}${String.fromCharCode(64 + col)}`;
                    const lock = document.createElement('div');
                    lock.className = 'lock available';
                    lock.dataset.id = lockId;
                    lock.dataset.zone = zoneId.replace('zone-', '');
                    lock.style.gridColumn = gridCol;
                    lock.style.gridRow = row;
                    
                    const lockIdElement = document.createElement('div');
                    lockIdElement.className = 'lock-id';
                    lockIdElement.textContent = lockId;
                    lock.appendChild(lockIdElement);
                    
                    const lockNameElement = document.createElement('div');
                    lockNameElement.className = 'lock-name';
                    
                    if (lockData[lockId]) {
                        lock.classList.remove('available');
                        lock.classList.add('booked');
                        lockNameElement.textContent = lockData[lockId].name;
                    }
                    
                    lock.appendChild(lockNameElement);
                    
                    const priceElement = document.createElement('div');
                    priceElement.className = 'lock-price';
                    priceElement.textContent = getLockPrice(lockId) + ' บาท';
                    lock.appendChild(priceElement);
                    
                    container.appendChild(lock);
                    
                    gridCol++;
                }
            }
        }

        // สร้างล็อคสำหรับโซนแบบแนวนอน (B, B2, C)
        function createHorizontalZone(zoneId, zoneInfo) {
            const container = document.getElementById(zoneId);
            container.innerHTML = '';
            const lockData = loadData();
            
            const totalCols = zoneInfo.pairsPerRow * 2 + (zoneInfo.pairsPerRow - 1);
            container.style.gridTemplateColumns = `repeat(${totalCols}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${zoneInfo.rows}, 1fr)`;
            
            for (let row = 1; row <= zoneInfo.rows; row++) {
                let gridCol = 1;
                let letterIndex = 0;
                
                for (let pair = 1; pair <= zoneInfo.pairsPerRow; pair++) {
                    const letters = zoneInfo.letters || ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                    
                    const lockId1 = `${zoneInfo.prefix}${row}${letters[letterIndex]}`;
                    
                    if (!zoneInfo.excludeLocks || !zoneInfo.excludeLocks.includes(lockId1)) {
                        const lock1 = document.createElement('div');
                        lock1.className = 'lock available';
                        lock1.dataset.id = lockId1;
                        lock1.dataset.zone = zoneId.replace('zone-', '');
                        lock1.style.gridColumn = gridCol++;
                        lock1.style.gridRow = row;
                        
                        const lockIdElement1 = document.createElement('div');
                        lockIdElement1.className = 'lock-id';
                        lockIdElement1.textContent = lockId1;
                        lock1.appendChild(lockIdElement1);
                        
                        const lockNameElement1 = document.createElement('div');
                        lockNameElement1.className = 'lock-name';
                        if (lockData[lockId1]) {
                            lock1.classList.remove('available');
                            lock1.classList.add('booked');
                            lockNameElement1.textContent = lockData[lockId1].name;
                        }
                        lock1.appendChild(lockNameElement1);
                        
                        const priceElement1 = document.createElement('div');
                        priceElement1.className = 'lock-price';
                        priceElement1.textContent = getLockPrice(lockId1) + ' บาท';
                        lock1.appendChild(priceElement1);
                        
                        container.appendChild(lock1);
                    } else {
                        gridCol++;
                    }
                    letterIndex++;
                    
                    const lockId2 = `${zoneInfo.prefix}${row}${letters[letterIndex]}`;
                    
                    if (!zoneInfo.excludeLocks || !zoneInfo.excludeLocks.includes(lockId2)) {
                        const lock2 = document.createElement('div');
                        lock2.className = 'lock available';
                        lock2.dataset.id = lockId2;
                        lock2.dataset.zone = zoneId.replace('zone-', '');
                        lock2.style.gridColumn = gridCol++;
                        lock2.style.gridRow = row;
                        
                        const lockIdElement2 = document.createElement('div');
                        lockIdElement2.className = 'lock-id';
                        lockIdElement2.textContent = lockId2;
                        lock2.appendChild(lockIdElement2);
                        
                        const lockNameElement2 = document.createElement('div');
                        lockNameElement2.className = 'lock-name';
                        if (lockData[lockId2]) {
                            lock2.classList.remove('available');
                            lock2.classList.add('booked');
                            lockNameElement2.textContent = lockData[lockId2].name;
                        }
                        lock2.appendChild(lockNameElement2);
                        
                        const priceElement2 = document.createElement('div');
                        priceElement2.className = 'lock-price';
                        priceElement2.textContent = getLockPrice(lockId2) + ' บาท';
                        lock2.appendChild(priceElement2);
                        
                        container.appendChild(lock2);
                    } else {
                        gridCol++;
                    }
                    letterIndex++;
                    
                    if (pair < zoneInfo.pairsPerRow) {
                        const walkway = document.createElement('div');
                        walkway.className = 'walkway';
                        walkway.style.gridColumn = gridCol++;
                        walkway.style.gridRow = row;
                        walkway.textContent = 'ทางเดิน';
                        container.appendChild(walkway);
                    }
                }
            }
        }

        // สร้างล็อคทั้งหมด
        function createAllLocks() {
            for (const zoneId in zones) {
                if (zones[zoneId].format === 'vertical') {
                    createVerticalZone(zoneId, zones[zoneId]);
                } else {
                    createHorizontalZone(zoneId, zones[zoneId]);
                }
            }
        }

        // ระบบจองล็อค
        function handleLockClick(e) {
            if (e.type === 'click' && e.clientX === 0 && e.clientY === 0) return;
            
            if (isScrolling) {
                isScrolling = false;
                return;
            }
            
            const lock = e.target.closest('.lock');
            if (!lock || lock.classList.contains('walkway')) return;
            
            if (e.cancelable) {
                e.preventDefault();
            }
            e.stopPropagation();
            
            const lockId = lock.dataset.id;
            const lockData = loadData();
            
            if (lock.classList.contains('available')) {
                currentBookingLock = lock;
                document.getElementById('booker-name').value = '';
                showModal('booking-modal');
            } else if (lock.classList.contains('booked')) {
                if (confirm(`ต้องการยกเลิกการจองล็อค ${lockId} ของ ${lock.querySelector('.lock-name').textContent} ใช่หรือไม่?`)) {
                    lock.classList.remove('booked');
                    lock.classList.add('available');
                    const zoneClass = lockId.startsWith('A') ? 'zone-a' : 
                                    lockId.startsWith('A2') ? 'zone-a2' :
                                    lockId.startsWith('B2') ? 'zone-b2' :
                                    lockId.startsWith('B') ? 'zone-b' : 'zone-c';
                    lock.classList.add(zoneClass);
                    lock.querySelector('.lock-name').textContent = '';
                    
                    delete lockData[lockId];
                    saveData(lockData);
                }
            }
        }

        // ยืนยันการจอง
        document.getElementById('confirm-booking').addEventListener('click', function() {
            const name = document.getElementById('booker-name').value.trim();
            if (!name) {
                alert('กรุณากรอกชื่อผู้จอง');
                return;
            }
            
            const lock = currentBookingLock;
            const lockId = lock.dataset.id;
            const lockData = loadData();
            
            lock.classList.remove('available');
            lock.classList.remove('zone-a', 'zone-a2', 'zone-b', 'zone-b2', 'zone-c');
            lock.classList.add('booked');
            lock.querySelector('.lock-name').textContent = name;
            
            lockData[lockId] = { 
                name: name, 
                date: new Date().toLocaleDateString('th-TH', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                price: getLockPrice(lockId)
            };
            saveData(lockData);
            
            hideModal('booking-modal');
            currentBookingLock = null;
        });

        // ยกเลิก Modal การจอง
        document.getElementById('cancel-booking').addEventListener('click', function() {
            hideModal('booking-modal');
            currentBookingLock = null;
        });

        // ระบบรีเซ็ตการจอง
        document.getElementById('reset-btn').addEventListener('click', function() {
            if (confirm('ต้องการรีเซ็ตการจองทั้งหมด ใช่หรือไม่?')) {
                const locks = document.querySelectorAll('.lock');
                locks.forEach(lock => {
                    if (!lock.classList.contains('walkway')) {
                        const lockId = lock.dataset.id;
                        const zoneId = Object.keys(zones).find(z => lockId.startsWith(zones[z].prefix));
                        if (zoneId && (!zones[zoneId].excludeLocks || !zones[zoneId].excludeLocks.includes(lockId))) {
                            lock.classList.remove('booked');
                            lock.classList.add('available');
                            const zoneClass = lockId.startsWith('A') ? 'zone-a' : 
                                            lockId.startsWith('A2') ? 'zone-a2' :
                                            lockId.startsWith('B2') ? 'zone-b2' :
                                            lockId.startsWith('B') ? 'zone-b' : 'zone-c';
                            lock.classList.add(zoneClass);
                            lock.querySelector('.lock-name').textContent = '';
                        }
                    }
                });
                
                const lockData = loadData();
                for (const lockId in lockData) {
                    const zoneId = Object.keys(zones).find(z => lockId.startsWith(zones[z].prefix));
                    if (zoneId && (!zones[zoneId].excludeLocks || !zones[zoneId].excludeLocks.includes(lockId))) {
                        delete lockData[lockId];
                    }
                }
                saveData(lockData);
            }
        });

        // ระบบแสดงผล
        document.getElementById('view-all').addEventListener('click', function() {
            document.querySelectorAll('.lock').forEach(lock => {
                lock.style.display = 'flex';
            });
        });

        document.getElementById('view-available').addEventListener('click', function() {
            document.querySelectorAll('.lock').forEach(lock => {
                if (lock.classList.contains('walkway')) {
                    lock.style.display = 'flex';
                } else {
                    lock.style.display = lock.classList.contains('available') ? 'flex' : 'none';
                }
            });
        });

        // ระบบค้นหาชื่อผู้จอง
        document.getElementById('search-btn').addEventListener('click', function() {
            const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
            if (!searchTerm) {
                alert('กรุณากรอกคำค้นหา');
                return;
            }
            
            const locks = document.querySelectorAll('.lock.booked');
            let found = false;
            
            locks.forEach(lock => {
                const name = lock.querySelector('.lock-name').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    lock.style.display = 'flex';
                    lock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    lock.style.boxShadow = '0 0 0 3px yellow';
                    setTimeout(() => {
                        lock.style.boxShadow = 'none';
                    }, 2000);
                    found = true;
                } else {
                    lock.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.lock.walkway').forEach(walkway => {
                walkway.style.display = 'flex';
            });
            
            if (!found) {
                alert('ไม่พบชื่อผู้จองที่ตรงกับคำค้นหา');
                document.getElementById('view-all').click();
            }
        });

        // ระบบแสดงรายงาน
        document.getElementById('show-report').addEventListener('click', function() {
            const lockData = loadData();
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = '';
            
            let totalIncome = 0;
            const zoneIncomes = {};
            
            const zoneData = {};
            for (const zoneId in zones) {
                zoneData[zoneId] = [];
            }
            
            for (const lockId in lockData) {
                const zonePrefix = lockId.substring(0, lockId.indexOf('-') > -1 ? lockId.indexOf('-') : 1);
                for (const zoneId in zones) {
                    if (zones[zoneId].prefix === zonePrefix || 
                        (zonePrefix === 'B2' && zones[zoneId].prefix === 'B')) {
                        if (!zones[zoneId].excludeLocks || !zones[zoneId].excludeLocks.includes(lockId)) {
                            zoneData[zoneId].push({
                                id: lockId,
                                name: lockData[lockId].name,
                                date: lockData[lockId].date,
                                price: lockData[lockId].price || getLockPrice(lockId)
                            });
                        }
                        break;
                    }
                }
            }
            
            const reportHeader = document.createElement('div');
            reportHeader.style.textAlign = 'center';
            reportHeader.style.marginBottom = '15px';
            
            const reportTitle = document.createElement('h2');
            reportTitle.textContent = 'รายงานการจองล็อคตลาดมาบตาพุด';
            reportHeader.appendChild(reportTitle);
            
            const reportDate = document.createElement('div');
            reportDate.textContent = 'วันที่ออกรายงาน: ' + new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            reportHeader.appendChild(reportDate);
            
            reportContent.appendChild(reportHeader);
            
            for (const zoneId in zoneData) {
                if (zoneData[zoneId].length > 0) {
                    let zoneIncome = 0;
                    
                    const zoneReport = document.createElement('div');
                    zoneReport.className = 'report-zone';
                    
                    const zoneTitle = document.createElement('div');
                    zoneTitle.className = 'report-zone-title';
                    zoneTitle.textContent = zones[zoneId].name + ` (${zoneData[zoneId].length} ล็อค)`;
                    zoneReport.appendChild(zoneTitle);
                    
                    zoneData[zoneId].forEach(item => {
                        zoneIncome += item.price;
                        
                        const reportItem = document.createElement('div');
                        reportItem.className = 'report-item';
                        
                        const lockInfo = document.createElement('div');
                        lockInfo.innerHTML = `${item.id}: ${item.name}<br><small>${item.price} บาท</small>`;
                        
                        const dateInfo = document.createElement('div');
                        dateInfo.textContent = item.date;
                        dateInfo.style.color = '#777';
                        dateInfo.style.fontSize = '0.8rem';
                        
                        reportItem.appendChild(lockInfo);
                        reportItem.appendChild(dateInfo);
                        zoneReport.appendChild(reportItem);
                    });
                    
                    zoneIncomes[zoneId] = zoneIncome;
                    totalIncome += zoneIncome;
                    
                    reportContent.appendChild(zoneReport);
                }
            }
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'report-summary';
            
            const summaryTitle = document.createElement('div');
            summaryTitle.style.fontWeight = 'bold';
            summaryTitle.style.marginBottom = '10px';
            summaryTitle.textContent = 'สรุปรายได้จากการจอง';
            summaryDiv.appendChild(summaryTitle);
            
            for (const zoneId in zoneIncomes) {
                const summaryItem = document.createElement('div');
                summaryItem.className = 'report-summary-item';
                
                const zoneName = document.createElement('div');
                zoneName.textContent = zones[zoneId].name;
                
                const zoneIncome = document.createElement('div');
                zoneIncome.textContent = zoneIncomes[zoneId].toLocaleString() + ' บาท';
                
                summaryItem.appendChild(zoneName);
                summaryItem.appendChild(zoneIncome);
                summaryDiv.appendChild(summaryItem);
            }
            
            const summaryTotal = document.createElement('div');
            summaryTotal.className = 'report-summary-item report-summary-total';
            
            const totalLabel = document.createElement('div');
            totalLabel.textContent = 'รวมทั้งหมด';
            
            const totalValue = document.createElement('div');
            totalValue.textContent = totalIncome.toLocaleString() + ' บาท';
            
            summaryTotal.appendChild(totalLabel);
            summaryTotal.appendChild(totalValue);
            summaryDiv.appendChild(summaryTotal);
            
            reportContent.appendChild(summaryDiv);
            
            if (reportContent.children.length === 1) {
                const emptyMessage = document.createElement('div');
                emptyMessage.style.textAlign = 'center';
                emptyMessage.style.color = '#777';
                emptyMessage.style.padding = '15px';
                emptyMessage.textContent = 'ไม่มีข้อมูลการจอง';
                reportContent.appendChild(emptyMessage);
            }
            
            showModal('report-modal');
        });

        // ปิด Modal รายงาน
        document.getElementById('close-report').addEventListener('click', function() {
            hideModal('report-modal');
        });

        // ระบบส่งออก CSV
        document.getElementById('export-csv').addEventListener('click', function() {
            const lockData = loadData();
            let csvContent = "รหัสล็อค,ชื่อผู้จอง,วันที่จอง,ราคา(บาท)\n";
            
            let totalIncome = 0;
            
            for (const lockId in lockData) {
                const price = lockData[lockId].price || getLockPrice(lockId);
                totalIncome += price;
                csvContent += `"${lockId}","${lockData[lockId].name}","${lockData[lockId].date}",${price}\n`;
            }
            
            csvContent += `"","","รวมทั้งหมด",${totalIncome}\n`;
            
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'รายงานการจองล็อค_ตลาดสตาร์_มาบตาพุด.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // ระบบแสดงผังรวม
        document.getElementById('print-map').addEventListener('click', function() {
            const mapContent = document.getElementById('map-content');
            mapContent.innerHTML = '';
            
            for (const zoneId in zones) {
                const zoneDiv = document.createElement('div');
                zoneDiv.className = 'map-zone';
                
                const zoneTitle = document.createElement('div');
                zoneTitle.className = 'map-zone-title';
                zoneTitle.textContent = zones[zoneId].name;
                zoneDiv.appendChild(zoneTitle);
                
                const locksGrid = document.createElement('div');
                locksGrid.className = 'map-locks-grid';
                
                if (zones[zoneId].format === 'vertical') {
                    createMapVerticalZone(locksGrid, zoneId, zones[zoneId]);
                } else {
                    createMapHorizontalZone(locksGrid, zoneId, zones[zoneId]);
                }
                
                zoneDiv.appendChild(locksGrid);
                mapContent.appendChild(zoneDiv);
            }
            
            showModal('map-modal');
        });

        // สร้างผังโซนแนวตั้งสำหรับผังรวม
        function createMapVerticalZone(container, zoneId, zoneInfo) {
            const lockData = loadData();
            const totalCols = zoneInfo.cols + zoneInfo.walkwayAfterCols.length;
            
            container.style.gridTemplateColumns = `repeat(${totalCols}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${zoneInfo.rows}, 1fr)`;
            
            for (let row = 1; row <= zoneInfo.rows; row++) {
                let gridCol = 1;
                
                for (let col = 1; col <= zoneInfo.cols; col++) {
                    if (zoneInfo.walkwayAfterCols.includes(col)) {
                        if (row === 1) {
                            const walkway = document.createElement('div');
                            walkway.className = 'walkway';
                            walkway.style.gridColumn = gridCol;
                            walkway.style.gridRow = `1 / span ${zoneInfo.rows}`;
                            walkway.textContent = 'ทางเดิน';
                            container.appendChild(walkway);
                        }
                        gridCol++;
                    }
                    
                    const lockId = `${zoneInfo.prefix}${row}${String.fromCharCode(64 + col)}`;
                    const lock = document.createElement('div');
                    lock.className = 'map-lock';
                    lock.dataset.id = lockId;
                    
                    if (lockData[lockId]) {
                        lock.classList.add('booked');
                    } else {
                        lock.classList.add('available');
                        lock.dataset.zone = zoneId.replace('zone-', '');
                    }
                    
                    lock.style.gridColumn = gridCol;
                    lock.style.gridRow = row;
                    
                    const lockIdElement = document.createElement('div');
                    lockIdElement.className = 'map-lock-id';
                    lockIdElement.textContent = lockId;
                    lock.appendChild(lockIdElement);
                    
                    if (lockData[lockId]) {
                        const lockNameElement = document.createElement('div');
                        lockNameElement.className = 'map-lock-name';
                        lockNameElement.textContent = lockData[lockId].name;
                        lock.appendChild(lockNameElement);
                    }
                    
                    container.appendChild(lock);
                    gridCol++;
                }
            }
        }

        // สร้างผังโซนแนวนอนสำหรับผังรวม
        function createMapHorizontalZone(container, zoneId, zoneInfo) {
            const lockData = loadData();
            const totalCols = zoneInfo.pairsPerRow * 2 + (zoneInfo.pairsPerRow - 1);
            
            container.style.gridTemplateColumns = `repeat(${totalCols}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${zoneInfo.rows}, 1fr)`;
            
            for (let row = 1; row <= zoneInfo.rows; row++) {
                let gridCol = 1;
                let letterIndex = 0;
                
                for (let pair = 1; pair <= zoneInfo.pairsPerRow; pair++) {
                    const letters = zoneInfo.letters || ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                    
                    const lockId1 = `${zoneInfo.prefix}${row}${letters[letterIndex]}`;
                    
                    if (!zoneInfo.excludeLocks || !zoneInfo.excludeLocks.includes(lockId1)) {
                        const lock1 = document.createElement('div');
                        lock1.className = 'map-lock';
                        lock1.dataset.id = lockId1;
                        
                        if (lockData[lockId1]) {
                            lock1.classList.add('booked');
                        } else {
                            lock1.classList.add('available');
                            lock1.dataset.zone = zoneId.replace('zone-', '');
                        }
                        
                        lock1.style.gridColumn = gridCol++;
                        lock1.style.gridRow = row;
                        
                        const lockIdElement1 = document.createElement('div');
                        lockIdElement1.className = 'map-lock-id';
                        lockIdElement1.textContent = lockId1;
                        lock1.appendChild(lockIdElement1);
                        
                        if (lockData[lockId1]) {
                            const lockNameElement1 = document.createElement('div');
                            lockNameElement1.className = 'map-lock-name';
                            lockNameElement1.textContent = lockData[lockId1].name;
                            lock1.appendChild(lockNameElement1);
                        }
                        
                        container.appendChild(lock1);
                    } else {
                        gridCol++;
                    }
                    letterIndex++;
                    
                    const lockId2 = `${zoneInfo.prefix}${row}${letters[letterIndex]}`;
                    
                    if (!zoneInfo.excludeLocks || !zoneInfo.excludeLocks.includes(lockId2)) {
                        const lock2 = document.createElement('div');
                        lock2.className = 'map-lock';
                        lock2.dataset.id = lockId2;
                        
                        if (lockData[lockId2]) {
                            lock2.classList.add('booked');
                        } else {
                            lock2.classList.add('available');
                            lock2.dataset.zone = zoneId.replace('zone-', '');
                        }
                        
                        lock2.style.gridColumn = gridCol++;
                        lock2.style.gridRow = row;
                        
                        const lockIdElement2 = document.createElement('div');
                        lockIdElement2.className = 'map-lock-id';
                        lockIdElement2.textContent = lockId2;
                        lock2.appendChild(lockIdElement2);
                        
                        if (lockData[lockId2]) {
                            const lockNameElement2 = document.createElement('div');
                            lockNameElement2.className = 'map-lock-name';
                            lockNameElement2.textContent = lockData[lockId2].name;
                            lock2.appendChild(lockNameElement2);
                        }
                        
                        container.appendChild(lock2);
                    } else {
                        gridCol++;
                    }
                    letterIndex++;
                    
                    if (pair < zoneInfo.pairsPerRow) {
                        const walkway = document.createElement('div');
                        walkway.className = 'walkway';
                        walkway.style.gridColumn = gridCol++;
                        walkway.style.gridRow = row;
                        walkway.textContent = 'ทางเดิน';
                        container.appendChild(walkway);
                    }
                }
            }
        }

        // ปุ่มพิมพ์ผัง
        document.getElementById('print-map-btn').addEventListener('click', function() {
            window.print();
        });

        // ปิด Modal ผังรวม
        document.getElementById('close-map').addEventListener('click', function() {
            hideModal('map-modal');
        });

        // ฟังก์ชันสำหรับแสดงและซ่อน Modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.height = '100%';
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            document.body.style.position = 'static';
            document.body.style.height = 'auto';
        }

        // ตั้งค่า Event Listeners สำหรับ iPad
        function setupIpadEvents() {
            const locks = document.querySelectorAll('.lock:not(.walkway)');
            
            locks.forEach(lock => {
                lock.addEventListener('touchstart', function(e) {
                    this.style.transform = 'scale(0.95)';
                    if (e.cancelable) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                lock.addEventListener('touchend', function(e) {
                    this.style.transform = '';
                    handleLockClick(e);
                    if (e.cancelable) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                lock.addEventListener('click', handleLockClick);
            });
            
            document.addEventListener('touchmove', function(e) {
                if (e.target.closest('.lock') && e.cancelable) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // ตรวจจับการเลื่อน
        function handleTouchStart() {
            isScrolling = false;
        }

        function handleTouchMove() {
            isScrolling = true;
        }

        // เรียกใช้เมื่อ DOM โหลดเสร็จ
        window.addEventListener('DOMContentLoaded', function() {
            createAllLocks();
            setupIpadEvents();
            
            // ตรวจจับการเลื่อน
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: true });
        });
    </script>
</body>
</html>